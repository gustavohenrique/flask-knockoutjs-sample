/*! poupaniquel - v0.1 - 2012-11-25
* http://gustavohenrique.net
* Copyright (c) 2012 Gustavo Henrique; Licensed MIT */
var poupaniquel={},$=$||{};poupaniquel.getAjax=function(e){var t;$.ajax({async:!1,url:e,contentType:"application/json",type:"GET",dataType:"json",success:function(e){t=e},error:function(e){t=e}});var n=function(){return t};return n()};var createGrid=function(e,t){var n=t.grid;n.source={localdata:e.items,datatype:"local"},$(n.elementId).jqxGrid(n),$(n.elementId).bind("rowselect",function(e){$(".btndelete").removeClass("disabled")})};poupaniquel.configure=function(e){var t=this;t.configuration=e;var n=t.getAjax(e.grid.services.load),r=t.utils.ko.mapping(n,e),i=new GridModel(r,e);if(e.hasOwnProperty("dropdown"))for(var s=0;s<e.dropdown.length;s++){var o=e.dropdown[s],u=o.datafield,a=o.root;try{i[u]=t.getAjax(o.url)[a],i["chosen"+u]=ko.observable()}catch(f){}}t.model=i,ko.applyBindings(i),createGrid(i,e),i.items.length===0&&i.addItem()};var GridModel=function(e,t){var n=this;n.items=e,n.configuration=t,t.hasOwnProperty("dateFormat")||(n.configuration.dateFormat="YYYY-MM-DD"),n.configuration.grid.hasOwnProperty("ordering")||(n.configuration.grid.ordering="asc");if(t.hasOwnProperty("methods")){var r=t.methods;for(var i=0;i<r.length;i++)method=r[i],n[method.name]=method.source}this.addItem=function(){var e={},t=n.configuration.grid.columns,r=function(e){e&&(this.isModified=!0)};for(var i=0;i<t.length;i++){var s=t[i].datafield,o=t[i].columntype,a="";switch(o){case"dropdownlist":a={id:0,name:""};break;case"numberinput":a=0;break;case"number":a=0;break;case"datetimeinput":a=new Date;break;case"date":a=moment?moment().format(n.configuration.dateFormat):new Date}e[s]=ko.observable(a),e.isModified=!1,e[s].subscribe(r,e)}n.configuration.grid.ordering==="asc"?n.items.push(e):n.items.unshift(e),u()},this.removeItem=function(){var e=n.getSelectedRowIndex();if(e>=0){var t=n.items[e];if(t){var r=n.items.splice(e,1)[0];u();var i=n.configuration.grid.services.remove,s=i.split("$"),o=s[s.length-1];r.hasOwnProperty(o)&&r[o]().toString().length>0&&(delete r.isModified,i=i.replace("$"+o,r[o]()),poupaniquel.getAjax(i))}n.items.length===0&&n.addItem()}},this.updateItem=function(){var e=s("isModified",n.items);if(e.length>0){var r={async:!0,url:t.grid.services.save,contentType:"application/json",type:"POST",dataType:"json",data:ko.toJSON(e)};t.grid.hasOwnProperty("success")&&(r.success=t.grid.success),t.grid.hasOwnProperty("error")&&(r.error=t.grid.error),$.ajax(r)}return e},this.refreshItems=function(){var e=poupaniquel.getAjax(t.grid.services.load),n=poupaniquel.utils.ko.mapping(e,t);poupaniquel.model=new GridModel(n,t),u()},this.filter=function(){var e=n.configuration.grid.root,t={fields:[{category:{id:2,name:"Internet"},payee:{id:4,name:"dealextreme"},amount:"-200",transaction_date:"2011-10-11",description:"Another thing",id:2}],total:1};n.items.splice(0,n.items.length);for(var r=0;r<t[e].length;r++){var i=t[e][r],s=poupaniquel.utils.ko.fromJson(i);n.items.push(s)}u(),$("#myModal").modal("hide")},this.getSelectedRowIndex=function(){var e=n.configuration.grid.elementId;return $(e).jqxGrid("getselectedrowindex")};var s=function(e,t){var n=[];for(var r=0;r<t.length;r+=1){var i=t[r];if(e in i&&i[e]===!0){var s=o(i);delete s.isModified,i.isModified=!1,n.push(s)}}return n},o=function(e){return jQuery.extend(!0,{},e)},u=function(){var e=n.configuration.grid.elementId;$(e).jqxGrid("updatebounddata")}};poupaniquel.utils={dropdown:{cellsrenderer:function(e,t,n){return n!==""?n.hasOwnProperty("name")?'<span style="margin: 4px; float: left;">'+n.name+"</span>":n:n},initeditor:function(e,t,n){var r=poupaniquel,i=0,s=r.model[this.datafield];if(t!==undefined&&t!==""&&s.length>0){var o=r.configuration.dropdown,u="";for(var a=0;a<o.length;a++){var f=o[a];if(this.datafield===f.datafield){u="root"in f?f.root:"";for(var l=0;l<s.length;l++)if(s[l].id===t.id){i=l,a=o.length;break}}}n.jqxDropDownList({valueMember:"id",displayMember:"name",source:s,selectedIndex:i,dropDownHeight:150,openDelay:0,closeDelay:0,animationType:"none",autoDropDownHeight:!1})}}},ko:{fromJson:function(e){var t={isModified:!1},n=function(e){e&&(this.isModified=!0)};for(var r in e)t[r]=ko.observable(e[r]),t[r].subscribe(n,t);return t},mapping:function(e,t){var n=t.error||function(e){alert(e.statusText)};if(e.hasOwnProperty("status")&&e.status!==200)return n(e),[];var r=[],i=t.grid.root;try{for(var s=0;s<e[i].length;s++){var o=e[i][s],u=this.fromJson(o);r.push(u)}}catch(a){}return r}}};